angular.module("image.crop").service("cropzone",["$rootScope","canvas",function(t,e){var i={rect:{},dragging:!1,initiated:!1,minHeight:25,minWidth:25,setWidth:function(t){t&&(t=parseInt(t),t<this.minWidth&&(t=this.minWidth),t>e.original.width&&(t=e.original.width-25),this.rect.width=t,this.rect.setTop((e.original.height-this.rect.getHeight())/2),this.rect.setLeft((e.original.width-this.rect.getWidth())/2),this.rect.setCoords(),this.drawGrid(),this.drawOverlay(),e.fabric.renderAll())},setHeight:function(t){t&&(t=parseInt(t),t<this.minHeight&&(t=this.minHeight),t>e.original.height&&(t=e.original.height-25),this.rect.height=t,this.rect.setTop((e.original.height-this.rect.getHeight())/2),this.rect.setLeft((e.original.width-this.rect.getWidth())/2),this.rect.setCoords(),this.drawGrid(),this.drawOverlay(),e.fabric.renderAll())},add:function(){this.drawMainZone(),this.drawOverlay(),this.drawGrid(),this.attachEvents(),e.fabric.renderAll(),this.initiated=!0,t.$emit("cropzone.added")},constrainWithinCanvas:function(t){var i=t.getLeft(),n=t.getTop(),r=t.getWidth(),o=t.getHeight(),s=e.original.width-r,a=e.original.height-o;0>i&&t.set("left",0),0>n&&t.set("top",0),i>s&&t.set("left",s),n>a&&t.set("top",a)},constrainWithinCanvasOnScaling:function(t){var i=t.getLeft(),n=t.getTop(),r=t.getLeft()+t.getWidth(),o=t.getTop()+t.getHeight();if(0>i||r>e.original.width){var s=this.lastScaleX||1;t.setScaleX(s)}if(0>i&&t.setLeft(0),0>n||o>e.original.height){var a=this.lastScaleY||1;t.setScaleY(a)}0>n&&t.setTop(0),t.getWidth()<this.minWidth&&(t.width=this.minWidth,t.setScaleX(1)),t.getHeight()<this.minHeight&&(t.height=this.minHeight,t.setScaleY(1)),this.lastScaleX=t.getScaleX(),this.lastScaleY=t.getScaleY()},onMouseDown:function(t){(!t.target||"cropzone"!==t.target.name&&"crop.grid"!==t.target.name)&&(i.dragging=!0,i.overlay.visible=!1,i.grid.visible=!1,i.rect.visible=!1,i.rect.left=t.e.pageX-e.fabric._offset.left,i.rect.top=t.e.pageY-e.fabric._offset.top,i.rect.scale(1),i.overlay.scale(1),i.grid.scale(1),i.mousex=t.e.pageX,i.mousey=t.e.pageY,e.fabric.selection=!1,i.drawOverlay())},onMouseMove:function(t){if(i.dragging){var n=t.e.pageX-i.mousex,r=t.e.pageY-i.mousey;e.offset.left+e.original.width<t.e.pageX&&(n=e.offset.left+e.original.width-i.mousex),e.offset.left>t.e.pageX&&(n=e.offset.left-i.mousex),e.offset.top+e.original.height<t.e.pageY&&(r=e.offset.top+e.original.height-i.mousey),e.offset.top>t.e.pageY&&(r=e.offset.top-i.mousey),i.rect.width=n,i.rect.height=r,i.rect.moveTo(3),i.rect.setCoords(),i.drawOverlay(),i.drawGrid(),i.rect.visible||(i.rect.visible=!0,i.overlay.visible=!0,i.grid.visible=!0)}},onMouseUp:function(){i.dragging=!1,e.fabric.selection=!0,i.rect.setCoords(),i.grid.setCoords(),i.overlay.setCoords(),i.rect.visible&&e.fabric.setActiveObject(i.rect)},attachEvents:function(){this.rect.on("moving",function(){i.constrainWithinCanvas(i.rect),i.drawOverlay(),i.drawGrid()}),this.rect.on("scaling",function(t){i.constrainWithinCanvasOnScaling(i.rect,t),i.drawOverlay(),i.drawGrid()}),e.fabric.on("mouse:down",i.onMouseDown),e.fabric.on("mouse:move",i.onMouseMove),e.fabric.on("mouse:up",i.onMouseUp)},remove:function(){e.fabric.off("mouse:down",i.onMouseDown),e.fabric.off("mouse:move",i.onMouseMove),e.fabric.off("mouse:up",i.onMouseUp),e.fabric.remove(this.rect),e.fabric.remove(this.grid),e.fabric.remove(this.overlay),e.fabric.renderAll(),this.initiated=!1},hide:function(){this.rect.visible=!1,this.rect.hasControls=!1,this.grid.visible=!1,this.overlay.visible=!1},getOptimalDimensions:function(){var t=e.original.width/2,i=e.original.height/2,n=e.original.width/4,r=e.original.height/4;return e.viewport.offsetWidth<e.original.width&&(t=e.viewport.offsetWidth/2,n=e.viewport.offsetWidth/4),e.viewport.offsetHeight<e.original.height&&(i=e.viewport.offsetHeight/2,r=e.viewport.offsetHeight/4),{width:t,height:i,left:n,top:r}},drawMainZone:function(){var t=this.getOptimalDimensions();this.rect=new fabric.Rect({fill:"transparent",stroke:"rgba(255, 255, 255, 0.6)",hasBorders:!1,width:t.width,height:t.height,left:t.left,top:t.top,hasRotatingPoint:!1,name:"cropzone",cornerColor:"rgba(255, 255, 255, 0.6)",transparentCorners:!1,ignore:!0}),e.fabric.add(this.rect),this.rect.moveTo(3),e.fabric.setActiveObject(i.rect)},drawGrid:function(){this.initiated||(this.line1=new fabric.Line([],{stroke:"rgba(255, 255, 255, 0.6)",strokeWidth:1,selectable:!1,evented:!1}),this.line2=new fabric.Line([],{stroke:"rgba(255, 255, 255, 0.6)",strokeWidth:1,selectable:!1,evented:!1}),this.line3=new fabric.Line([],{stroke:"rgba(255, 255, 255, 0.6)",strokeWidth:1,selectable:!1,evented:!1}),this.line4=new fabric.Line([],{stroke:"rgba(255, 255, 255, 0.6)",strokeWidth:1,selectable:!1,evented:!1}),this.grid=new fabric.Group([this.line1,this.line2,this.line3,this.line4]),this.grid.originY="left",this.grid.originX="top",this.grid.ignore=!0,this.grid.selectable=!1,e.fabric.add(this.grid),this.grid.moveTo(10)),this.grid.width=this.rect.getWidth(),this.grid.height=this.rect.getHeight(),this.grid.left=this.rect.getLeft(),this.grid.top=this.rect.getTop();var t=i.rect.getWidth()/3,n=i.rect.getHeight()/3;this.line1.set({x1:t,y1:0,x2:t,y2:i.grid.getHeight()}),this.line2.set({x1:2*t,y1:0,x2:2*t,y2:i.grid.getHeight()}),this.line3.set({x1:0,y1:n,x2:i.grid.getWidth(),y2:n}),this.line4.set({x1:0,y1:2*n,x2:i.grid.getWidth(),y2:2*n}),this.constrainWithinCanvas(this.grid)},drawOverlay:function(){this.initiated||(this.topRect=new fabric.Rect({fill:"rgba(0,0,0,0.7)",selectable:!0,evented:!1}),this.rightRect=new fabric.Rect({fill:"rgba(0,0,0,0.7)",selectable:!0,evented:!1}),this.bottomRect=new fabric.Rect({fill:"rgba(0,0,0,0.7)",selectable:!0,evented:!1}),this.leftRect=new fabric.Rect({fill:"rgba(0,0,0,0.7)",selectable:!0,evented:!1}),this.overlay=new fabric.Group([this.topRect,this.rightRect,this.bottomRect,this.leftRect]),this.overlay.ignore=!0,this.overlay.name="grid.overlay",e.fabric.add(this.overlay),this.overlay.moveTo(1)),this.topRect.set({left:0,top:0,width:e.original.width,height:this.rect.getHeight()<0?this.rect.getTop()-Math.abs(this.rect.getHeight()):this.rect.getTop()}),this.rightRect.set({left:this.rect.getWidth()<0?this.rect.getLeft():this.rect.getLeft()+this.rect.getWidth(),top:this.rect.getTop(),width:this.rect.getWidth()<0?e.original.width-(this.rect.getLeft()+this.rect.getWidth())-Math.abs(this.rect.getWidth()):e.original.width-(this.rect.getLeft()+this.rect.getWidth()),height:this.rect.getHeight()}),this.bottomRect.set({left:0,top:this.rect.getHeight()<0?this.rect.getTop():this.rect.getTop()+this.rect.getHeight(),width:e.original.width,height:this.rect.getHeight()<0?e.original.height-this.rect.getTop():e.original.height-(this.rect.getTop()+this.rect.getHeight())}),this.leftRect.set({left:0,top:this.rect.getTop(),width:this.rect.getWidth()>0?this.rect.getLeft():this.rect.getLeft()-Math.abs(this.rect.getWidth()),height:this.rect.getHeight()})}};return i}]);