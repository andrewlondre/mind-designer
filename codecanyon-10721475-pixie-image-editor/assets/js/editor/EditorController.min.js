angular.module("ImageEditor").controller("EditorController",["$scope","$rootScope","$http","$state","folders","canvas","saver","photos","utils","selectedItem",function(e,t,i,n,r,o,a,s,l,c){function u(i){o.fabric.deactivateAll().renderAll();var n=o.fabric.toDatalessJSON(["selectable","name"]);n.customActions=angular.copy(t.editorCustomActions);for(var a=n.customActions&&n.customActions.roundCorners?"png":i.extension,s=o.fabric.toDataURL({format:a||"png",quality:1}),l=o.original,c=0;c<n.objects.length;c++){var u=n.objects[c];if("mainImage"===u.name){u.src=e.active.originalUrl;break}}return console.log(n),angular.isString(n)||(n=JSON.stringify(n)),{id:i.id,name:i.name||t.userPreset.name,folder_id:i.folder_id||r.selected.id,serialized_editor_state:n,imageData:s,width:l.width,height:l.height,extension:a}}function d(e){var t=JSON.parse(e.serialized_editor_state);t.customActions&&!$.isEmptyObject(t.customActions)&&(o.fabric.clear(),o.zoom(1),o.loadMainImage(e.absoluteUrl))}e.active={},a.saveImage=function(){e.ajaxInProgress=!0;var i=u(e.active);if(i.id)var n=c.update(i);else var n=s.save(i);n.success(function(t){l.showToast("savedPhotoSuccessfully",!0),e.active=t})["finally"](function(){e.ajaxInProgress=!1}),t.$emit("activity.happened","edited","photo",[i])};var f=t.$on("canvas.init",function(){n.params.id?i.get(t.baseUrl+"photos/"+n.params.id).success(function(i){e.active=i,c.set(i),i.serialized_editor_state?o.loadFromJSON(i,d):o.loadMainImage(i.originalUrl),t.started=!0}):(o.openNew(t.userPreset.width,t.userPreset.height,t.userPreset.name),t.started=!0)});e.$on("$destroy",function(){o.destroy(),t.started=!1,f()}),$(".pagination").click("a",function(e){e.preventDefault()})}]);