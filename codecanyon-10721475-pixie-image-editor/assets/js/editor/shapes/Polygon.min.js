angular.module("image.shapes").service("polygon",["$rootScope","$mdDialog","canvas",function(t,e,i){var n={mode:"add",currentShape:!1,onMouseMove:function(t){var e=i.fabric.getPointer(t.e);if("edit"===n.mode&&n.currentShape){var r=n.currentShape.get("points");r[r.length-1].x=e.x-n.currentShape.get("left"),r[r.length-1].y=e.y-n.currentShape.get("top"),n.currentShape.set({points:r}),i.fabric.renderAll()}},onMouseDown:function(t){var e=i.fabric.getPointer(t.e);if("add"===n.mode){var r=new fabric.Polygon([{x:e.x,y:e.y},{x:e.x+.5,y:e.y+.5}],{fill:"black",opacity:1,selectable:!1});n.currentShape=r,n.currentShape.name="polygon",i.fabric.add(n.currentShape),n.mode="edit"}else if("edit"===n.mode&&n.currentShape&&"polygon"===n.currentShape.type){var o=n.currentShape.get("points");o.push({x:e.x-n.currentShape.get("left"),y:e.y-n.currentShape.get("top")}),n.currentShape.set({points:o}),i.fabric.renderAll()}},onEscape:function(t){(!t&&n.currentShape||t&&27===t.keyCode)&&("edit"===n.mode||"add"===n.mode?(n.mode="normal",n.currentShape.set({selectable:!0}),n.currentShape._calcDimensions(),n.currentShape.setCoords(),i.fabric.setActiveObject(n.currentShape),i.fabric.renderAll()):n.mode="add",n.currentShape=null)},onClick:function(t){var e=$(t.target).closest(".md-dialog-container")[0];"CANVAS"===t.target.nodeName||"polygon"===$(t.target).closest(".shape").data("name")||e||n.disable()},enable:function(){this.enabled||(this.enabled=!0,i.fabric.on("mouse:move",n.onMouseMove),i.fabric.on("mouse:down",n.onMouseDown),fabric.util.addListener(window,"keyup",n.onEscape),setTimeout(function(){fabric.util.addListener(window,"click",n.onClick)},20),e.show({templateUrl:"modals/polygon.html",clickOutsideToClose:!0,controller:["$scope","$mdDialog",function(t,e){t.closeModal=e.hide}]}))},disable:function(){this.enabled=!1,i.fabric.off("mouse:move",n.onMouseMove),i.fabric.off("mouse:down",n.onMouseDown),fabric.util.removeListener(window,"keyup",n.onEscape),fabric.util.removeListener(window,"click",n.onClick),n.onEscape()}};return n}]);