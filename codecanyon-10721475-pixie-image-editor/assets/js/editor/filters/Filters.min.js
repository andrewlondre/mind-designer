"use strict";angular.module("image.filters").service("filters",["$rootScope","canvas","history",function(t,e,i){var n={all:[{name:"grayscale"},{name:"invert"},{name:"sepia"},{name:"sepia2"},{name:"removeWhite",options:{distance:{current:10},threshold:{current:50}}},{name:"brightness",options:{brightness:{current:50}}},{name:"noise",options:{noise:{current:40,max:600}}},{name:"GradientTransparency",displayName:"Gradient",options:{threshold:{current:40}}},{name:"pixelate",options:{blocksize:{max:40,current:2}}},{name:"sharpen",uses:"Convolute",matrix:[0,-1,0,-1,5,-1,0,-1,0]},{name:"blur",uses:"Convolute",matrix:[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9]},{name:"emboss",uses:"Convolute",matrix:[1,1,1,1,.7,-1,-1,-1,-1]},{name:"tint",options:{opacity:{current:.5,min:.1,max:1,step:.1},color:{colorpicker:!0,current:"#FF4081"}}},{name:"multiply",options:{color:{colorpicker:!0,current:"#FF4081"}}},{name:"blend",options:{mode:{current:"add",select:!0,available:["add","multiply","subtract","diff","screen","lighten","darken"]},alpha:{current:.5,min:.1,max:1,step:.1},color:{colorpicker:!0,current:"#FF4081"}}}],appliedFilters:[],applyFilter:function(r){if(this.filterExists(r)){if(this.filterAlreadyApplied(r.name))return this.removeFilter(r);t.isLoading(),n.markAsApplied(r.name),setTimeout(function(){e.fabric.forEachObject(function(t){t.applyFilters&&(t.filters.push(n.getFilter(r)),t.applyFilters(e.fabric.renderAll.bind(e.fabric)))}),i.add("filter: "+(r.displayName||r.name),"brightness-6"),n.lastAppliedFilter=r,t.isNotLoading()},30)}},removeFilter:function(i){this.filterExists(i)&&(t.isLoading(),n.unmarkAsApplied(i.name),setTimeout(function(){e.fabric.forEachObject(function(t){if(t.applyFilters)for(var n=0;n<t.filters.length;n++)t.filters[n].name.toLowerCase()===i.name.toLowerCase()&&(t.filters.splice(n,1),t.applyFilters(e.fabric.renderAll.bind(e.fabric)))}),n.lastAppliedFilter=!1,t.isNotLoading()},30))},applyValue:function(i,n,r){t.isLoading(),setTimeout(function(){e.fabric.forEachObject(function(t){if(t.applyFilters)for(var o=0;o<t.filters.length;o++){var s=t.filters[o];s.type.toLowerCase()===i.toLowerCase()&&(s[n]=r,t.applyFilters(e.fabric.renderAll.bind(e.fabric)))}}),t.isNotLoading()},30)},filterAlreadyApplied:function(t){return-1!==this.appliedFilters.indexOf(t)},markAsApplied:function(t){-1===this.appliedFilters.indexOf(t)&&this.appliedFilters.push(t)},unmarkAsApplied:function(t){for(var e=0;e<this.appliedFilters.length;e++)this.appliedFilters[e]===t&&this.appliedFilters.splice(e,1)},filterExists:function(t){return void 0!==fabric.Image.filters[fabric.util.string.capitalize(t.uses||t.name,!0)]},getFilter:function(t){var e;if(t.uses)e=new(fabric.Image.filters[fabric.util.string.capitalize(t.uses,!0)])({matrix:t.matrix});else{var i={};for(var n in t.options)i[n]=t.options[n].current;e=new(fabric.Image.filters[fabric.util.string.capitalize(t.name,!0)])(i)}return e.name=t.name,e}};return n}]);