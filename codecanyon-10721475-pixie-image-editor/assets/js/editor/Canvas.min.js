angular.module("ImageEditor").service("canvas",["$rootScope","$mdDialog","keybinds",function(e,t,i){var n={original:{},oldWindowDimensions:{width:window.innerWidth,height:window.innerHeight},mainImage:!1,fabric:!1,ctx:!1,container:!1,viewport:!1,offset:!1,element:!1,minWidth:50,minHeight:50,imageStatic:{locked:!0,selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1},destroy:function(){this.fabric.dispose(),this.mainImage=!1,this.fabric=!1,this.ctx=!1,this.container=!1,this.viewport=!1,this.offset=!1,this.element=!1,this.original={},this.currentZoom=1,e.editorCustomActions={},$(window).off("resize"),i.destroy()},start:function(r){if(this.element=document.getElementById("canvas"),this.fabric=new fabric.Canvas("canvas"),this.ctx=this.fabric.getContext("2d"),this.container=$(".canvas-container"),this.viewport=document.getElementById("viewport"),e.editorCustomActions={},this.fabric.selection=!1,this.fabric.renderOnAddRemove=!1,fabric.Object.prototype.borderColor="#2196F3",fabric.Object.prototype.cornerColor="#2196F3",fabric.Object.prototype.transparentCorners=!1,r||(r=e.getParam("url")),r)this.loadMainImage(r),e.started=!0;else if(e.getParam("blankCanvasSize")){var o=e.getParam("blankCanvasSize");this.openNew(o.width,o.height,"newCanvas"),e.started=!0}e.started||e.isIntegrationMode||e.delayEditorStart||t.show({template:$("#main-image-upload-dialog-template").html(),controller:"TopPanelController",clickOutsideToClose:!1}),$(window).off("resize").on("resize",function(e){(n.oldWindowDimensions.height!==e.target.innerHeight||n.oldWindowDimensions.width!==e.target.innerWidth)&&n.fitToScreen(),n.oldWindowDimensions.width=e.target.innerWidth,n.oldWindowDimensions.height=e.target.innerHeight}),e.$emit("canvas.init"),i.init(this.fabric),e.getParam("onLoad")&&e.getParam("onLoad")(this.viewport,e,window)},hideModals:function(){t.hide()},mergeObjects:function(){n.zoom(1),this.fabric.deactivateAll();var e=this.fabric.toDataURL();this.fabric.clear(),this.loadMainImage(e)},loadFromJSON:function(t,i){n.fabric.loadFromJSON(t.serialized_editor_state||t.state,function(){n.fabric.forEachObject(function(e){e.applyFilters&&e.filters.length&&e.applyFilters(n.fabric.renderAll.bind(n.fabric)),"mainImage"==e.name&&(n.mainImage=e)}),t.width&&t.height&&(n.fabric.setWidth(t.width),n.fabric.setHeight(t.height),n.original.height=t.height,n.original.width=t.width),n.fabric.renderAll(),n.fabric.calcOffset(),n.fitToScreen(),e.$emit("history.loaded"),i&&i(t)})},openNew:function(t,i,r){t=t<this.minWidth?this.minWidth:t,i=i<this.minHeight?this.minHeight:i,this.fabric.clear(),this.fabric.setWidth(t),this.fabric.setHeight(i),this.fabric.renderAll(),n.fitToScreen(),e.userPreset={width:t,height:i,name:r},n.original.height=i,n.original.width=t,e.$emit("canvas.openedNew")},center:function(e){e.center(),n.zoom>100&&(e.setLeft(10),e.setTop(35)),e.setCoords()},serialize:function(){return this.fabric.toJSON(["selectable","name"])},loadMainImage:function(t,i,r,o,a){var s;fabric.util.loadImage(t,function(t){s=new fabric.Image(t,n.imageStatic),s.name="mainImage",r&&i&&(s.width=r,s.height=i),n.mainImage=s,n.fabric.forEachObject(function(e){"mainImage"==e.name&&n.fabric.remove(e)}),n.fabric.add(s),s.top=-.5,s.left=-.5,s.moveTo(0),n.fabric.setHeight(s.height),n.fabric.setWidth(s.width),n.original.height=s.height,n.original.width=s.width,o||n.fitToScreen(),e.$apply(function(){e.$emit("editor.mainImage.loaded")}),a&&a()})},openImage:function(e){n.zoom(1),fabric.util.loadImage(e,function(e){if(e){var t=new fabric.Image(e);t.name="image";var i=n.mainImage?n.mainImage.getWidth():n.fabric.getWidth(),r=n.mainImage?n.mainImage.getHeight():n.fabric.getHeight();if(t.width>=i||t.height>=r){var o=i-.1*i,a=r-.1*r,s=1/Math.min(a/t.getHeight(),o/t.getWidth());t.scaleX=t.scaleX*(1/s),t.scaleY=t.scaleY*(1/s)}n.fabric.add(t),t.left=(n.fabric.getWidth()-t.getWidth())/2,t.top=(n.fabric.getHeight()-t.getHeight())/2,t.setCoords(),n.fabric.setActiveObject(t),n.fabric.renderAll(),n.fitToScreen()}})},getDataURL:function(e){return e||(e={}),e.multiplier=1/n.currentZoom,this.fabric.toDataURL(e)},currentZoom:1,zoom:function(e){this.fabric.setZoom(e),this.fabric.setHeight(this.original.height*e),this.fabric.setWidth(this.original.width*e),this.currentZoom=e},fitToScreen:function(){var e=n.viewport.offsetWidth-40,t=n.viewport.offsetHeight-120,i=n.mainImage||n.fabric,r=Math.min(t/i.getHeight(),e/i.getWidth());(i.getHeight()>t||i.getWidth()>e)&&n.zoom(r)}};return n}]);